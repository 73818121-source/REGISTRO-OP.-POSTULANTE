<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Personal Operador y Conductor</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button {
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom: 3px solid #ffc108; /* Esmeralda 500 */
            color: #ffc108;
            font-weight: 600;
        }
        .exp-input {
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 50;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        
        <!-- Logo y Encabezado -->
        <header class="p-6 bg-white flex flex-col items-center">
            <img src="img/logo_mota_engil.jpg" onerror="this.src='https://placehold.co/100x40/2563EB/FFFFFF?text=VAL+TECH';" alt="Logo" class="h-40 mb-4">
            <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800 text-center">REGISTRO DE PERSONAL OPERADOR Y CONDUCTOR</h1>
            <p class="text-sm text-gray-500 text-center mt-1">Sistema de gestión de postulantes y Validación de experiencia laboral.</p>
        </header>
        
        <!-- Datos del Responsable de RRHH (Persistentes) -->
        <div class="p-4 border-y border-gray-300 bg-blue-50">
            <h2 class="text-lg font-bold text-blue-800 mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                Datos del Responsable de Registro (RRHH)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="hr-responsible" class="block text-sm font-medium text-gray-700">Responsable</label>
                    <input id="hr-responsible" name="hrResponsible" type="text" placeholder="Ej: Maria Rojas" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                </div>
                <div>
                    <label for="hr-position" class="block text-sm font-medium text-gray-700">Cargo / Puesto</label>
                    <input id="hr-position" name="hrPosition" type="text" placeholder="Ej: Analista de Selección" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                </div>
            </div>
        </div>
        <!-- FIN SECCIÓN RRHH -->

        <!-- Pestañas de Navegación -->
        <div class="flex border-b border-gray-200 bg-gray-50 px-6">
            <button id="tab-register" class="tab-button active p-4 text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out" onclick="showTab('register')">
                <svg class="w-5 h-5 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 18h.01"></path></svg>
                Registrar Nuevo Operador
            </button>
            <button id="tab-summary" class="tab-button p-4 text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out" onclick="showTab('summary')">
                <svg class="w-5 h-5 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Resumen de Postulantes
            </button>
        </div>

        <!-- Área de Contenido -->
        <div class="p-6">
            
            <!-- Contenido de la Pestaña de Registro (EXISTENTE) -->
            <div id="content-register" class="tab-content">
                <form id="registration-form" class="space-y-8">
                    
                    <!-- I. Datos Personales e Identificación -->
                    <div class="border p-4 rounded-lg bg-orange-50">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">I. Datos Personales e Identificación</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="dni" class="block text-sm font-medium text-gray-700">Nº Documento de Identidad (DNI)</label>
                                <input id="dni" name="dni" type="text" placeholder="73818121" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                            </div>
                            <div>
                                <label for="names" class="block text-sm font-medium text-gray-700">Nombres</label>
                                <input id="names" name="names" type="text" placeholder="airton soto" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                            </div>
                            <div>
                                <label for="surnames" class="block text-sm font-medium text-gray-700">Apellidos</label>
                                <input id="surnames" name="surnames" type="text" placeholder="soto galarza" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                            </div>
                            <div>
                                <label for="dob" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                                <input id="dob" name="dob" type="date" value="1994-04-30" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required onchange="calculateAge()">
                                <p id="age-display" class="text-xs text-gray-500 mt-1">Edad calculada: -- años</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- II. Licencia y Ubicación -->
                    <div class="border p-4 rounded-lg bg-orange-50">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">II. Licencia y Ubicación</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="license-category" class="block text-sm font-medium text-gray-700">Categoría de Licencia</label>
                                <select id="license-category" name="licenseCategory" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                                    <option value="A-I">A-I</option>
                                    <option value="A-IIA">A-IIA</option>
                                    <option value="A-IIB" selected>A-IIB</option>
                                    <option value="A-IIIA">A-IIIA</option>
                                    <option value="A-IIIB">A-IIIB</option>
                                </select>
                            </div>
                            <div>
                                <label for="revalidation-date" class="block text-sm font-medium text-gray-700">Fecha de Revalidación</label>
                                <input id="revalidation-date" name="revalidationDate" type="date" value="1994-04-30" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                            </div>
                            <div>
                                <label for="origin-place" class="block text-sm font-medium text-gray-700">Lugar de Procedencia</label>
                                <select id="origin-place" name="originPlace" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                                    <option value="Lima">Lima</option>
                                    <option value="Arequipa">Arequipa</option>
                                    <option value="Cusco">Cusco</option>
                                    <option value="Puno">Puno</option>
                                </select>
                            </div>
                            <div>
                                <label for="assigned-project" class="block text-sm font-medium text-gray-700">Proyecto/Área Asignada</label>
                                <select id="assigned-project" name="assignedProject" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" required>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- III. Experiencia Laboral con Equipos (Sección Dinámica) -->
                    <div class="border p-4 rounded-lg bg-blue-50">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">III. Experiencia Laboral con Equipos</h2>
                        <p class="text-sm italic text-gray-600 mb-4">*Añada los períodos y equipos certificados.</p>
                        
                        <div id="experience-container" class="space-y-4">
                            <!-- Los bloques de experiencia se insertarán aquí por JavaScript -->
                        </div>

                        <button type="button" onclick="addExperienceBlock()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-2 px-3 rounded-lg transition duration-200 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Agregar otra Experiencia
                        </button>
                        
                        <div id="experience-summary" class="mt-6 p-3 border border-green-300 bg-green-50 rounded-lg text-sm font-medium">
                            Resumen de Experiencia por Equipo: <span class="text-green-700">No hay experiencia registrada.</span>
                        </div>

                        <input type="hidden" name="experienceJson" id="experience-json-data">
                    </div>

                    <!-- IV. Documentación y Notas -->
                    <div class="border p-4 rounded-lg bg-orange-50">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">IV. Documentación y Notas</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="document-upload" class="block text-sm font-medium text-gray-700">Certificado Adjunto (Simulación)</label>
                                <input type="file" id="document-upload" name="documentUpload" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
                                <p class="text-xs text-gray-500 mt-1">Solo se guarda el nombre del archivo adjunto.</p>
                            </div>
                            <div>
                                <label for="observations" class="block text-sm font-medium text-gray-700">Observaciones Adicionales</label>
                                <textarea id="observations" name="observations" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Notas importantes sobre el postulante."></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="message-container" class="mt-4 text-sm font-medium" role="alert"></div>
                    
                    <div class="flex justify-end gap-4 pt-4 border-t border-gray-200">
                        <button type="button" onclick="document.getElementById('registration-form').reset(); clearExperiences()" class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Limpiar Formulario
                        </button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-xl transition duration-200 transform hover:scale-[1.01] flex items-center justify-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Guardar Operador
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Contenido de la Pestaña de Resumen de Postulantes (NUEVO) -->
            <div id="content-summary" class="tab-content hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen de Últimos 10 Postulantes</h2>
                
                <!-- Contenedor para la tabla de resumen -->
                <div id="summary-container" class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DNI</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombres Completos</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Licencia</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proyecto</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="p-6 text-center text-gray-500">Haz clic en la pestaña "Resumen de Postulantes" para cargar los datos.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Overlay de Carga (GLOBAL) -->
    <div id="loading-overlay" class="loading-overlay">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span id="loading-text" class="mt-4 text-lg font-medium text-gray-700">Cargando datos...</span>
    </div>

    <!-- Modal de Edición (NUEVO) -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Editar Registro</h3>
            <form id="edit-form" onsubmit="handleEditSubmit(event)">
                <input type="hidden" id="edit-row-index">
                <div class="mb-4">
                    <label for="edit-dni" class="block text-sm font-medium text-gray-700">DNI</label>
                    <input type="text" id="edit-dni" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <label for="edit-names" class="block text-sm font-medium text-gray-700">Nombres (Corregido)</label>
                    <input type="text" id="edit-names" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="edit-surnames" class="block text-sm font-medium text-gray-700">Apellidos (Corregido)</label>
                    <input type="text" id="edit-surnames" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm" required>
                </div>
                
                <div id="edit-message-container" class="mt-4 text-sm font-medium hidden p-2 rounded-lg" role="alert"></div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // ¡IMPORTANTE! REEMPLAZA ESTA URL CON LA URL DE DESPLIEGUE DE TU GOOGLE APPS SCRIPT.
        const SCRIPT_URL = 'REEMPLAZAR_CON_URL_DE_APPS_SCRIPT'; 
        
        // --- Constantes de Datos de Listas ---
        const PROJECT_AREAS = [
            "PR-Las Bambas (Minería)", "PR-Toromocho", "C.V Juliaca", 
            "C.V. Puerto Bermudez", "Puente Tarata", "C.V. Tambogrande", 
            "Taller Ate-Chilca"
        ];
        
        const EQUIPMENT_TYPES = [
            "Auto Hormigonera", "Bus", "Calentador de asfalto", "Cama baja", 
            "Camión Articulado", "Camión baranda", "Camión Bomba de Concreto", 
            "Camión Concretero", "Camión Esparcidor de Asfalto", "Camión Furgón", 
            "Camión Grúa", "Camión Imprimador", "Camión Lubricador", "Camión Plataforma", 
            "Camión tracto", "Camioneta", "Cargador frontal", "Chancadora", 
            "Cisterna de agua", "Cisterna de asfalto", "Cisterna de combustible", 
            "Coaster", "Combi", "Esparcidora", "Excavadora con Martillo Hidráulico", 
            "Excavadora sobre neumáticos", "Excavadora sobre orugas", "Grúa Celosía", 
            "Grúa Celosía con Martillo", "Grúa Telescópica", "Grúa Torre", 
            "Manlift", "Minibús", "Montacargador", "Motoniveladora", 
            "Pavimentadora de asfalto", "Pavimentadora de Concreto", 
            "Perforadora Hidráulica", "Planta de asfalto", "Planta de Concreto", 
            "Planta de inyección", "Planta dosificadora", "Plataforma de Elevación", 
            "Puente Grúa", "Recicladora de asfalto", "Remolque", "Retroexcavadora", 
            "Rigger", "Rodillo Bermero", "Rodillo Neumático", "Rodillo tandem", 
            "Rodillo vibratorio", "Semi Remolque", "Semi Remolque cisterna", 
            "Camión Caja Transportadora", "Telehandler", "Tractor sobre orugas", 
            "Van", "Vehículo de Transferencia", "Volquete (Volvo)", "Zaranda"
        ];

        let experienceCounter = 0; // Contador para IDs únicos de bloques de experiencia

        // --- Funciones de Utilidad ---

        function initializeSelects() {
            const projectSelect = document.getElementById('assigned-project');
            PROJECT_AREAS.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                projectSelect.appendChild(option);
            });
            addExperienceBlock(true);
            calculateAge(); 
        }
        
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Cargar resumen cuando la pestaña se activa
            if (tabId === 'summary') {
                loadSummary();
            }
        }

        function alertUser(message, type, containerId = 'message-container') {
            const msgContainer = document.getElementById(containerId);
            msgContainer.innerHTML = message;
            msgContainer.className = 'mt-4 text-sm font-medium p-3 rounded-lg';
            
            if (type === 'success') {
                msgContainer.classList.add('text-green-700', 'bg-green-100');
            } else if (type === 'error') {
                msgContainer.classList.add('text-red-700', 'bg-red-100');
            } else if (type === 'warning') {
                msgContainer.classList.add('text-yellow-700', 'bg-yellow-100');
            }
            msgContainer.classList.remove('hidden');

            setTimeout(() => {
                if(containerId === 'message-container') {
                    msgContainer.textContent = '';
                    msgContainer.className = 'mt-4 text-sm font-medium';
                }
            }, 8000);
        }

        function calculateAge() {
            const dobInput = document.getElementById('dob').value;
            const ageDisplay = document.getElementById('age-display');
            if (!dobInput) {
                ageDisplay.textContent = 'Edad calculada: -- años';
                return;
            }
            
            const birthDate = new Date(dobInput);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            ageDisplay.textContent = `Edad calculada: ${age} años`;
        }
        
        function addExperienceBlock(isInitial = false) {
            experienceCounter++;
            const container = document.getElementById('experience-container');
            const expId = `exp-block-${experienceCounter}`;
            const isRemovable = !isInitial || experienceCounter > 1; 
            
            const equipmentOptions = EQUIPMENT_TYPES.map(eq => `<option value="${eq}">${eq}</option>`).join('');

            const newBlock = document.createElement('div');
            newBlock.id = expId;
            newBlock.className = 'p-4 border border-gray-300 rounded-lg bg-white shadow-sm space-y-3';
            newBlock.innerHTML = `
                <h4 class="text-sm font-semibold text-gray-700">Experiencia #${experienceCounter} <span id="duration-${expId}" class="text-xs text-blue-600 font-normal">(Duración: --)</span></h4>
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                    <div class="sm:col-span-1">
                        <label class="block text-xs font-medium text-gray-500">Equipo a Cargo</label>
                        <select data-field="equipment" class="mt-1 block w-full border border-gray-300 rounded-lg exp-input" required>
                            <option value="" disabled selected>Seleccionar</option>
                            ${equipmentOptions}
                        </select>
                    </div>
                    <div class="sm:col-span-1">
                        <label class="block text-xs font-medium text-gray-500">Empresa</label>
                        <input type="text" data-field="company" placeholder="mota engil peru" class="mt-1 block w-full border border-gray-300 rounded-lg exp-input" required>
                    </div>
                    <div class="sm:col-span-1">
                        <label class="block text-xs font-medium text-gray-500">F. Inicial</label>
                        <input type="date" data-field="startDate" class="mt-1 block w-full border border-gray-300 rounded-lg exp-input" required>
                    </div>
                    <div class="sm:col-span-1">
                        <label class="block text-xs font-medium text-gray-500">F. Final</label>
                        <input type="date" data-field="endDate" class="mt-1 block w-full border border-gray-300 rounded-lg exp-input" required>
                    </div>
                </div>
                ${isRemovable ? 
                    `<div class="flex justify-end">
                        <button type="button" onclick="removeExperienceBlock('${expId}')" class="text-red-500 hover:text-red-700 text-xs font-semibold p-1 rounded transition duration-150">
                            Eliminar
                        </button>
                    </div>` : ''
                }
            `;
            container.appendChild(newBlock);
            
            // Adjuntar listener para el cálculo de duración y resumen
            const dateInputs = newBlock.querySelectorAll('[data-field="startDate"], [data-field="endDate"]');
            dateInputs.forEach(input => {
                input.addEventListener('change', () => updateExperienceDuration(expId));
            });
            
            newBlock.querySelector('[data-field="equipment"]').addEventListener('change', calculateTotalExperience);

            updateExperienceDuration(expId);
        }
        
        function removeExperienceBlock(id) {
             document.getElementById(id)?.remove();
             calculateTotalExperience();
        }

        function calculateDuration(startStr, endStr) {
             if (!startStr || !endStr) return '';

            const start = new Date(startStr);
            const end = new Date(endStr);

            if (start > end) return 'Fechas inválidas';

            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();

            if (months < 0) {
                years--;
                months += 12;
            }

            const yearStr = years > 0 ? `${years} año${years !== 1 ? 's' : ''}` : '';
            const monthStr = months > 0 ? `${months} mes${months !== 1 ? 'es' : ''}` : '';

            if (years === 0 && months === 0) return 'Menos de 1 mes';
            return [yearStr, monthStr].filter(Boolean).join(', ');
        }
        
        function updateExperienceDuration(id) {
            const block = document.getElementById(id);
            const startDate = block.querySelector('[data-field="startDate"]').value;
            const endDate = block.querySelector('[data-field="endDate"]').value;
            const durationSpan = document.getElementById(`duration-${id}`);
            
            const duration = calculateDuration(startDate, endDate);
            durationSpan.textContent = `(Duración: ${duration || '--'})`;
            
            calculateTotalExperience();
        }
        
        function calculateTotalExperience() {
            const experienceData = [];
            const container = document.getElementById('experience-container');
            const expBlocks = container.querySelectorAll('.p-4');

            expBlocks.forEach(block => {
                const startDate = block.querySelector('[data-field="startDate"]').value;
                const endDate = block.querySelector('[data-field="endDate"]').value;
                const equipment = block.querySelector('[data-field="equipment"]').value;
                const company = block.querySelector('[data-field="company"]').value;

                if (startDate && endDate && equipment && company) {
                    experienceData.push({
                        equipment,
                        company,
                        startDate,
                        endDate
                    });
                }
            });

            // Agrupar y sumar experiencia por equipo
            const summary = experienceData.reduce((acc, exp) => {
                const start = new Date(exp.startDate);
                const end = new Date(exp.endDate);
                
                if (start > end) return acc; // Ignorar fechas inválidas

                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (!acc[exp.equipment]) {
                    acc[exp.equipment] = 0;
                }
                acc[exp.equipment] += diffDays;

                return acc;
            }, {});

            // Formatear el resumen
            let summaryText = '';
            let totalDays = 0;
            
            for (const equipment in summary) {
                const days = summary[equipment];
                const totalMonths = Math.floor(days / 30.44); // Promedio de días por mes
                const years = Math.floor(totalMonths / 12);
                const months = totalMonths % 12;
                
                const yearStr = years > 0 ? `${years} año${years !== 1 ? 's' : ''}` : '';
                const monthStr = months > 0 ? `${months} mes${months !== 1 ? 'es' : ''}` : '';
                
                const durationStr = [yearStr, monthStr].filter(Boolean).join(', ');
                
                summaryText += `<span class="block ml-4">• ${equipment} (${durationStr || 'Menos de 1 mes'})</span>`;
                totalDays += days;
            }
            
            const totalMonths = Math.floor(totalDays / 30.44);
            const totalYears = Math.floor(totalMonths / 12);
            const remainingMonths = totalMonths % 12;
            
            const totalYearStr = totalYears > 0 ? `${totalYears} año${totalYears !== 1 ? 's' : ''}` : '';
            const totalMonthStr = remainingMonths > 0 ? `${remainingMonths} mes${remainingMonths !== 1 ? 'es' : ''}` : '';
            const totalDurationStr = [totalYearStr, totalMonthStr].filter(Boolean).join(', ');
            
            const summaryDiv = document.getElementById('experience-summary');
            if (summaryText) {
                summaryDiv.innerHTML = `
                    <p class="font-bold">Resumen de Experiencia por Equipo:</p>
                    ${summaryText}
                    <p class="mt-2 text-xs text-gray-600">Experiencia Total Acumulada: <span class="font-semibold text-green-700">${totalDurationStr || 'Menos de 1 mes'}</span></p>
                `;
            } else {
                 summaryDiv.innerHTML = 'Resumen de Experiencia por Equipo: <span class="text-green-700">No hay experiencia registrada.</span>';
            }
            
            document.getElementById('experience-json-data').value = JSON.stringify(experienceData);
        }

        function clearExperiences() {
            document.getElementById('experience-container').innerHTML = '';
            experienceCounter = 0;
            addExperienceBlock(true);
            calculateTotalExperience();
        }

        // --- Conexión con Apps Script ---

        async function fetchAppsScript(action, data) {
            if (SCRIPT_URL === 'REEMPLAZAR_CON_URL_DE_APPS_SCRIPT') {
                alertUser('Error de configuración: Por favor, actualiza SCRIPT_URL con la URL de tu Apps Script.', 'error');
                return { status: 'error', message: 'Configuración pendiente.' };
            }
            
            document.getElementById('loading-text').textContent = (action === 'register') ? 'Guardando registro completo...' : 
                                                                 (action === 'get_summary') ? 'Cargando resumen...' : 'Guardando edición...';
            document.getElementById('loading-overlay').style.display = 'flex';

            const payload = { action: action, data: data };
            let response = { status: 'error', message: 'Error de red o respuesta vacía.' };

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    response = await res.json();
                } else {
                    response.message = `Error HTTP: ${res.status} - ${res.statusText}. Verifica el despliegue de tu Apps Script.`;
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                response.message = `Fallo en la conexión: ${error.message}`;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }

            return response;
        }

        // --- Manejo del Formulario de Registro Principal ---

        document.getElementById('registration-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            calculateTotalExperience(); 
            
            const form = event.target;
            const fileInput = document.getElementById('document-upload');
            const experienceJson = document.getElementById('experience-json-data').value;
            
            const hrResponsible = document.getElementById('hr-responsible').value.trim();
            const hrPosition = document.getElementById('hr-position').value.trim();
            
            if (!hrResponsible || !hrPosition) {
                alertUser('Por favor, complete los campos de Responsable de RRHH.', 'warning');
                return;
            }
            
            const data = {
                hrResponsible: hrResponsible,
                hrPosition: hrPosition,
                
                dni: form.dni.value.trim(),
                names: form.names.value.trim(),
                surnames: form.surnames.value.trim(),
                dob: form.dob.value,
                licenseCategory: form.licenseCategory.value,
                revalidationDate: form.revalidationDate.value,
                originPlace: form.originPlace.value,
                assignedProject: form.assignedProject.value,
                experienceData: experienceJson, 
                documentName: fileInput.files.length > 0 ? fileInput.files[0].name : '',
                observations: form.observations.value.trim()
            };

            if (!data.dni) {
                alertUser('El campo DNI es obligatorio.', 'warning');
                return;
            }

            const result = await fetchAppsScript('register', data);
            
            if (result.status === 'success') {
                alertUser(result.message, 'success');
                form.reset(); 
                clearExperiences(); 
                document.getElementById('hr-responsible').value = hrResponsible;
                document.getElementById('hr-position').value = hrPosition;
            } else {
                alertUser(`Error al registrar: ${result.message}`, 'error');
            }
        });

        // --- Lógica de Resumen de Postulantes ---

        async function loadSummary() {
            const result = await fetchAppsScript('get_summary', { limit: 10 });
            const body = document.getElementById('summary-table-body');
            
            body.innerHTML = ''; // Limpiar tabla

            if (result.status === 'success' && result.data && result.data.length > 0) {
                renderSummaryTable(result.data);
            } else if (result.status === 'success') {
                body.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No hay registros de postulantes.</td></tr>';
            } else {
                body.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Error al cargar datos: ${result.message}</td></tr>`;
            }
        }

        function renderSummaryTable(data) {
            const body = document.getElementById('summary-table-body');
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition duration-150';
                
                // Los índices de columna coinciden con HEADERS en Apps Script
                const rowIndex = row[0]; // El primer elemento es el índice de la fila en Sheets
                const dni = row[4];
                const names = row[5];
                const surnames = row[6];
                const license = row[8];
                const project = row[11];
                
                tr.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${dni}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${names} ${surnames}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${license}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${project}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium">
                        <button onclick="openEditModal({
                            rowIndex: ${rowIndex}, 
                            dni: '${dni}', 
                            names: '${names.replace(/'/g, "\\'")}', 
                            surnames: '${surnames.replace(/'/g, "\\'")}'
                        })" class="text-blue-600 hover:text-blue-900 font-semibold p-1 rounded-md bg-blue-50 hover:bg-blue-100 transition">
                            Editar
                        </button>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        // --- Lógica del Modal de Edición ---

        function openEditModal(applicant) {
            document.getElementById('edit-row-index').value = applicant.rowIndex;
            document.getElementById('edit-dni').value = applicant.dni;
            document.getElementById('edit-names').value = applicant.names;
            document.getElementById('edit-surnames').value = applicant.surnames;
            document.getElementById('edit-message-container').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        async function handleEditSubmit(event) {
            event.preventDefault();
            
            const rowIndex = document.getElementById('edit-row-index').value;
            const dni = document.getElementById('edit-dni').value;
            const names = document.getElementById('edit-names').value.trim();
            const surnames = document.getElementById('edit-surnames').value.trim();
            const msgContainer = document.getElementById('edit-message-container');
            
            if (!names || !surnames) {
                 alertUser('Los campos Nombres y Apellidos son obligatorios.', 'warning', 'edit-message-container');
                 return;
            }

            const data = {
                rowIndex: rowIndex,
                dni: dni,
                names: names,
                surnames: surnames
            };
            
            msgContainer.classList.remove('hidden');
            msgContainer.className = 'mt-4 text-sm font-medium p-2 rounded-lg bg-yellow-100 text-yellow-700';
            msgContainer.textContent = 'Guardando cambios...';

            const result = await fetchAppsScript('edit_applicant', data);

            if (result.status === 'success') {
                alertUser(result.message, 'success', 'edit-message-container');
                setTimeout(() => {
                    closeEditModal();
                    loadSummary(); // Recargar la tabla para mostrar los cambios
                    alertUser(`Registro DNI ${dni} actualizado.`, 'success');
                }, 1500);
            } else {
                alertUser(`Error al editar: ${result.message}`, 'error', 'edit-message-container');
            }
        }

        // Inicialización de la aplicación
        window.onload = initializeSelects;
    </script>
</body>
</html>
